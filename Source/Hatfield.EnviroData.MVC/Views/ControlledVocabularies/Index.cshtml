<script src="~/Scripts/jquery.signalR-1.2.2.js"></script>
<!--Reference the autogenerated SignalR hub script. -->

<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">@ViewBag.Title</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-bar-chart-o fa-fw"></i> Update CV Terms
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <h5><button class=" btn btn-info"  id="updatecv">Update Controlled Vocabularies from Web Service</button></h5>
                    
                        <p>
                            Last updated: <div id="dateUpdated">
    @if (ViewBag.LastRunTime != null)
    {
        @ViewBag.LastRunTime
    }
    else
    {
        @Html.Raw("The Updater has not been run yet")

    }
</div>
</p>
                    

                    <p>Click this button in order to periodically synchronize the Controlled Vocabularies maintained by ODM2 administrators with the database</p>
                    <br />
                    <div class="progress" style="display: none;">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                        </div>
                    </div>
                    <div id="cvstatus">                       
                    </div>

                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->

        </div>
    </div>
</div>



<script>
    $(function () {
        // Reference the auto-generated proxy for the hub.
        var cvStatus = $.connection.cVHub;
        // Create a function that the hub can call back to display messages.
        cvStatus.client.sendMessage = function (message) {
            // Add the message to the page.
            $('#cvstatus').text(htmlEncode(message));
        };

        cvStatus.client.updateDateTime = function(dateTime)
        {
            $("#dateUpdated").text(dateTime);
        }
        cvStatus.client.updateProgress = function(percentage)
        {
            $(".progress-bar").css('width', percentage + '%');
            $(".progress-bar").text(percentage + '%');
            if (percentage == 100) {
                $(".progress-bar").text("Done!");
                $('.progress-bar').removeClass('active');

            }
        }

        $.connection.hub.start().done(function () {
            $('#updatecv').click(function () {
                $(".progress").show()
                // Call the Send method on the hub.
                cvStatus.server.send();
                // Clear text box and reset focus for next comment.
                $('#cvstatus').val('').focus();
            });
        });
    });
    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
</script>
<script src="~/signalr/hubs"></script>